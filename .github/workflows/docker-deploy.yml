deploy-k3s:
  needs: deploy-docker
  runs-on: self-hosted
  timeout-minutes: 60
  steps:
    - name: üõé Checkout du code (avec fichiers k8s)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: "üñ•Ô∏è Installer K3s (si n√©cessaire)"
      run: |
        # V√©rifier si k3s est d√©j√† install√©
        if ! command -v k3s &> /dev/null; then
          echo "Installation de k3s..."
          LOCAL_IP=$(hostname -I | awk '{print $1}')
          curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=${{ env.K3S_VERSION }} sh -s - \
            --disable metrics-server \
            --disable traefik \
            --write-kubeconfig-mode 644 \
            --tls-san ${LOCAL_IP}
          
          # Configurer le stockage local
          sudo mkdir -p /mnt/data/postgres
          sudo chmod 777 /mnt/data/postgres
        else
          echo "k3s est d√©j√† install√© (version $(k3s --version))"
        fi
        
        # Configurer l'acc√®s kubectl
        mkdir -p $HOME/.kube
        LOCAL_IP=$(hostname -I | awk '{print $1}')
        sudo sed "s/127.0.0.1/${LOCAL_IP}/g" /etc/rancher/k3s/k3s.yaml > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    - name: "üîß V√©rifier l'installation"
      run: |
        export KUBECONFIG=$HOME/.kube/config
        kubectl cluster-info
        kubectl get nodes
        kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml

    - name: üõ†Ô∏è Installer MetalLB depuis vos fichiers
      run: |
        export KUBECONFIG=$HOME/.kube/config
        if [ -d "k8s/metallb/" ]; then
          kubectl apply -f k8s/metallb/
        else
          echo "::error::Vos fichiers MetalLB sont introuvables dans k8s/metallb/"
          exit 1
        fi
        sleep 30

    - name: üê≥ D√©ployer Portainer depuis vos fichiers
      run: |
        export KUBECONFIG=$HOME/.kube/config
        if [ -d "k8s/portainer/" ]; then
          kubectl apply -f k8s/portainer/
        else
          echo "::error::Vos fichiers Portainer sont introuvables dans k8s/portainer/"
          exit 1
        fi

    - name: üöÄ D√©ployer le frontend
      run: |
        export KUBECONFIG=$HOME/.kube/config
        if [ -d "frontend/k8s/" ]; then
          sed -i "s|\$DOCKER_IMAGE|${{ env.DOCKER_IMAGE }}|g" frontend/k8s/deployment.yaml
          sed -i "s|\$TAG|${{ github.sha }}|g" frontend/k8s/deployment.yaml
          kubectl apply -f frontend/k8s/
        else
          echo "::error::Vos fichiers de d√©ploiement frontend sont introuvables dans frontend/k8s/"
          exit 1
        fi

    - name: üìä V√©rifier les d√©ploiements
      run: |
        export KUBECONFIG=$HOME/.kube/config
        echo "=== √âtat du cluster ==="
        kubectl get nodes
        echo "=== Pods ==="
        kubectl get pods -A
        echo "=== Services ==="
        kubectl get svc -A
        echo "=== URLs d'acc√®s ==="
        echo "Portainer: http://$(hostname -I | awk '{print $1}'):$(kubectl get svc -n portainer -o jsonpath='{.items[0].spec.ports[0].nodePort}')"
        echo "Frontend: http://$(kubectl get svc frontend-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"